<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ—Ä–≤—å—é</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        raifYellow: '#FFED00',
                        raifDark: '#2B2D33',
                        raifGray: '#6B7280',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white min-h-screen">
    <div class="min-h-screen font-sans max-w-6xl mx-auto px-4 py-8">
        <!-- Back Button -->
        <a href="/" class="inline-flex items-center text-raifDark hover:text-raifGray transition-colors mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
            </svg>
            –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        </a>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-100">
            <!-- Interview Info Panel -->
            <div class="bg-gray-50 p-6 rounded-t-2xl border-b border-gray-100">
                <h2 class="text-xl font-bold text-raifDark mb-4">–¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-sm font-medium text-raifGray mb-1">–ü—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</p>
                        <p id="personaDisplay" class="text-raifDark font-medium">{{ persona if persona else "Not specified" }}</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-sm font-medium text-raifGray mb-1">–û—Ü–µ–Ω–∏–≤–∞–µ–º—ã–π –Ω–∞–≤—ã–∫</p>
                        <p id="skillDisplay" class="text-raifDark font-medium">{{ skill if skill else "Not specified" }}</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-sm font-medium text-raifGray mb-1">–£—Ä–æ–≤–µ–Ω—å —á–µ—Å—Ç–Ω–æ—Å—Ç–∏</p>
                        <p id="honestyDisplay" class="text-raifDark font-medium">{{ honesty_level if honesty_level else "Not specified" }}</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-sm font-medium text-raifGray mb-1">–£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞</p>
                        <p id="experienceDisplay" class="text-raifDark font-medium">{{ experience_level if experience_level else "Not specified" }}</p>
                    </div>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connection-status" class="bg-yellow-50 px-6 py-3 border-b border-yellow-100 text-yellow-700 text-center">
                –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
            </div>

            <!-- Chat Area -->
            <div class="p-6">
                <div id="messages" class="mb-6 h-[400px] overflow-y-auto space-y-4 p-4 bg-gray-50 rounded-xl"></div>
                
                <!-- Input Area -->
                <div class="space-y-4">
                    <form id="chat-form" onsubmit="sendMessage(event)" class="flex space-x-3">
                        <input 
                            type="text" 
                            id="messageText" 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" 
                            class="flex-1 p-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-raifYellow focus:border-transparent outline-none transition-all"
                            disabled
                        >
                        <button 
                            type="submit" 
                            class="bg-raifDark text-white px-6 py-3 rounded-xl font-medium hover:bg-raifDark/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </form>

                    <!-- Control Buttons -->
                    <div class="flex justify-between items-center">
                        <button 
                            id="endInterviewBtn" 
                            onclick="endInterview()" 
                            class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl font-medium transition-colors"
                        >
                            –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é
                        </button>
                        <div class="flex items-center space-x-4">
                            <span id="recordingStatus" class="text-raifGray"></span>
                            <button 
                                id="recordButton" 
                                onclick="toggleRecording()" 
                                class="bg-raifDark text-white px-6 py-3 rounded-xl font-medium hover:bg-raifDark/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                –ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Decorative Elements -->
        <div class="absolute left-0 top-1/4 -z-10">
            <div class="w-24 h-24 bg-raifYellow/20 rounded-full blur-xl"></div>
        </div>
        <div class="absolute right-0 bottom-1/4 -z-10">
            <div class="w-32 h-32 bg-raifYellow/20 rounded-full blur-xl"></div>
        </div>
    </div>

    <script>
    // --- –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–Ω—Ç–µ—Ä–≤—å—é –∏–∑ URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const currentPersona = urlParams.get('persona');
    const currentSkill = urlParams.get('skill');
    const currentHonesty = urlParams.get('honesty_level');
    const currentExperience = urlParams.get('experience_level');

    // –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –≤—ã–±–æ—Ä –ø—Ä–æ—Ñ–∏–ª—è
    if (!currentPersona || !currentSkill || !currentHonesty || !currentExperience) {
        window.location.href = '/select-persona';
    }

    // --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ---
    document.getElementById('personaDisplay').textContent = currentPersona;
    document.getElementById('skillDisplay').textContent = currentSkill;
    document.getElementById('honestyDisplay').textContent = `${currentHonesty}/10 (${currentHonesty < 5 ? '–±–æ–ª–µ–µ —Ö–∏—Ç—Ä—ã–π' : '–±–æ–ª–µ–µ —á–µ—Å—Ç–Ω—ã–π'})`;
    document.getElementById('experienceDisplay').textContent = `${currentExperience}/10 (${currentExperience < 5 ? '–Ω–æ–≤–∏—á–æ–∫' : '–æ–ø—ã—Ç–Ω—ã–π'})`;

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ, —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π ---
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let isConnected = false;
    let isWaitingForResponse = false;
    let ws;

    // --- –ò—Å—Ç–æ—Ä–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ ---
    const conversationHistory = {
        timestamp: new Date().toISOString(),
        persona: currentPersona,
        skill: currentSkill,
        honesty_level: currentHonesty,
        experience_level: currentExperience,
        messages: []
    };

    // --- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –¥–ª—è –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –∏ –∞—É–¥–∏–æ ---
    function connectWebSocket() {
        let wsHost = window.location.host;
        if (!wsHost || wsHost === 'false') wsHost = 'localhost:8000';
        const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
        const wsUrl = `${wsProtocol}://${wsHost}/ws/interview?persona=${encodeURIComponent(currentPersona)}&skill=${encodeURIComponent(currentSkill)}&honesty_level=${currentHonesty}&experience_level=${currentExperience}`;
        ws = new WebSocket(wsUrl);
        updateConnectionStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'yellow');
        ws.onopen = () => {
            isConnected = true;
            updateConnectionStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'green');
            enableInterface();
        };
        ws.onclose = (event) => {
            isConnected = false;
            disableInterface();
            if (event.code === 1000) {
                updateConnectionStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'yellow');
            } else {
                updateConnectionStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'red');
                showError('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.');
            }
        };
        ws.onerror = (error) => {
            updateConnectionStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'red');
        };
        ws.onmessage = handleWebSocketMessage;
    }

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–µ–∫—Å—Ç/–∞—É–¥–∏–æ/–æ—à–∏–±–∫–∏) ---
    function handleWebSocketMessage(event) {
        try {
            const response = JSON.parse(event.data);
            if (response.type === 'error') {
                showError(`–û—à–∏–±–∫–∞: ${response.text}`);
                resetWaitingState();
                return;
            }
            if (['text', 'voice'].includes(response.type)) {
                processMessage(response);
                updateChatDisplay();
                hideStatusMessage();
                resetWaitingState();
            }
        } catch {
            showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            resetWaitingState();
        }
    }

    // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏—é, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ ---
    function processMessage(response) {
        if (response.type === 'voice' && response.user_text) addUserMessage(response.user_text);
        if (response.content && response.content.trim()) {
            addAssistantMessage(response.content);
            if (response.type === 'voice' && response.audio) {
                hideStatusMessage();
                playAudio(response.audio);
            }
        }
    }

    // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é ---
    function addUserMessage(content) {
        const lastUserMessage = getLastMessageByRole('user');
        if (!lastUserMessage || lastUserMessage.content !== content) {
            conversationHistory.messages.push({ role: "user", content });
        }
    }
    function addAssistantMessage(content) {
        const lastAssistantMessage = getLastMessageByRole('assistant');
        if (!lastAssistantMessage || lastAssistantMessage.content !== content) {
            conversationHistory.messages.push({ role: "assistant", content });
        }
    }
    function getLastMessageByRole(role) {
        return conversationHistory.messages.filter(msg => msg.role === role).pop();
    }
    function resetWaitingState() {
        isWaitingForResponse = false;
        enableInterface();
    }
    function hideStatusMessage() {
        updateConnectionStatus('', '');
    }

    // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ---
    function updateChatDisplay() {
        const messagesEl = document.getElementById('messages');
        messagesEl.innerHTML = "";
        conversationHistory.messages.forEach(msg => {
            const div = document.createElement('div');
            const isUser = msg.role === 'user';
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`;
            div.innerHTML = `
                <div class="max-w-[70%] ${isUser ? 'bg-raifDark text-white' : 'bg-gray-100 text-raifDark'} rounded-2xl px-4 py-3">
                    <div class="text-sm font-medium mb-1">${isUser ? 'üë§ –í—ã' : 'ü§ñ –ö–∞–Ω–¥–∏–¥–∞—Ç'}</div>
                    <div>${msg.content}</div>
                </div>
            `;
            messagesEl.appendChild(div);
        });
        scrollChatToBottom();
    }
    function scrollChatToBottom() {
        const messagesEl = document.getElementById('messages');
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function showError(message) {
        const statusElement = document.getElementById('connection-status');
        statusElement.textContent = message;
        statusElement.className = 'px-6 py-3 text-center border-b bg-red-50 border-red-100 text-red-700';
        statusElement.classList.remove('hidden');
    }

    // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä ---
    function sendMessage(event) {
        event.preventDefault();
        if (!isConnected || isWaitingForResponse) return;
        const input = document.getElementById("messageText");
        const userMsg = input.value.trim();
        if (userMsg === "") return;
        addUserMessage(userMsg);
        updateChatDisplay();
        try {
            ws.send(JSON.stringify({ type: "text", message: userMsg }));
            input.value = '';
            isWaitingForResponse = true;
            disableInterface(true);
        } catch {
            showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        }
    }

    // --- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ-–æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ ---
    function playAudio(base64Audio) {
        if (!base64Audio) return;
        try {
            const audio = new Audio();
            audio.src = 'data:audio/mp3;base64,' + base64Audio;
            setupAudioEventHandlers(audio);
            audio.play().catch(error => showError('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ: ' + error.message));
        } catch (error) {
            showError('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∞—É–¥–∏–æ: ' + error.message);
        }
    }
    function setupAudioEventHandlers(audio) {
        audio.onplay = () => {};
        audio.onended = () => {};
        audio.onerror = () => showError('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ');
    }

    // --- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤—å—é, —ç–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –≤ —Ñ–∞–π–ª –∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é ---
    function endInterview() {
        if (!conversationHistory.messages.length) {
            alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤—å—é –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º.");
            return;
        }
        if (!confirm("–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?")) return;
        try {
            exportInterviewData();
            closeConnection();
            redirectToHome();
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–Ω—Ç–µ—Ä–≤—å—é: ' + error.message);
        }
    }
    function exportInterviewData() {
        const interviewData = {
            timestamp: new Date().toISOString(),
            persona: currentPersona,
            skill: currentSkill,
            honesty_level: currentHonesty,
            experience_level: currentExperience,
            messages: conversationHistory.messages,
        };
        if (!interviewData.messages.length) throw new Error("–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        const jsonData = JSON.stringify(interviewData, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const fileName = generateFileName(currentPersona);
        downloadBlob(blob, fileName);
    }
    function generateFileName(persona) {
        const sanitizedPersona = persona.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g, '_').substring(0, 20);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        return `interview_${sanitizedPersona}_${timestamp}.json`;
    }
    function downloadBlob(blob, fileName) {
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(blob);
        downloadLink.download = fileName;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(downloadLink.href);
    }
    function closeConnection() {
        if (ws && ws.readyState === WebSocket.OPEN) ws.close(1000, "Interview completed");
    }
    function redirectToHome() {
        setTimeout(() => { window.location.href = "/"; }, 1000);
    }

    // --- –†–∞–±–æ—Ç–∞ —Å –∑–∞–ø–∏—Å—å—é –∏ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∞—É–¥–∏–æ (startRecording, stopRecording, processRecordedAudio –∏ –¥—Ä.) ---
    async function toggleRecording() {
        if (!isConnected || isWaitingForResponse) return;
        if (!isRecording) {
            startRecording();
        } else {
            stopRecording();
        }
    }
    async function startRecording() {
        const recordButton = document.getElementById('recordButton');
        const statusElement = document.getElementById('recordingStatus');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            setupRecordingHandlers();
            mediaRecorder.start();
            isRecording = true;
            updateRecordingUI(true);
        } catch {
            statusElement.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
            showError('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
        }
    }
    function stopRecording() {
        mediaRecorder.stop();
        isRecording = false;
        updateRecordingUI(false);
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }
    function setupRecordingHandlers() {
        mediaRecorder.ondataavailable = (event) => { audioChunks.push(event.data); };
        mediaRecorder.onstop = () => { processRecordedAudio(); };
    }
    async function processRecordedAudio() {
        try {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            convertBlobToBase64(audioBlob, sendAudioToServer);
        } catch {
            showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ');
        }
    }
    function convertBlobToBase64(blob, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => {
            const base64Audio = reader.result.split(',')[1];
            callback(base64Audio);
        };
    }
    function sendAudioToServer(base64Audio) {
        const payload = JSON.stringify({
            type: "audio",
            audio: base64Audio,
            format: 'webm'
        });
        try {
            ws.send(payload);
            updateConnectionStatus('–ê—É–¥–∏–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...', 'yellow');
            isWaitingForResponse = true;
            disableInterface(true);
        } catch {
            showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ');
        }
    }
    function updateRecordingUI(isRecordingActive) {
        const recordButton = document.getElementById('recordButton');
        const statusElement = document.getElementById('recordingStatus');
        if (isRecordingActive) {
            recordButton.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
            recordButton.classList.add('bg-red-600');
            recordButton.classList.remove('bg-raifDark');
            statusElement.textContent = '–ó–∞–ø–∏—Å—å...';
            document.getElementById('messageText').disabled = true;
            document.querySelector('#chat-form button[type="submit"]').disabled = true;
        } else {
            recordButton.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å –≥–æ–ª–æ—Å';
            recordButton.classList.remove('bg-red-600');
            recordButton.classList.add('bg-raifDark');
            statusElement.textContent = '';
        }
    }

    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ ---
    function updateConnectionStatus(message, color) {
        const statusElement = document.getElementById('connection-status');
        if (!message) {
            statusElement.classList.add('hidden');
            return;
        }
        statusElement.textContent = message;
        statusElement.className = 'px-6 py-3 text-center border-b';
        const colorClasses = {
            'green': ['bg-green-50', 'border-green-100', 'text-green-700'],
            'yellow': ['bg-yellow-50', 'border-yellow-100', 'text-yellow-700'],
            'red': ['bg-red-50', 'border-red-100', 'text-red-700']
        };
        if (colorClasses[color]) {
            statusElement.classList.add(...colorClasses[color]);
        }
    }
    function enableInterface() { setInterfaceState(false); }
    function disableInterface(waitingMode = false) { setInterfaceState(true, waitingMode); }
    function setInterfaceState(disabled, waitingMode = false) {
        const elements = [
            document.getElementById('messageText'),
            document.querySelector('#chat-form button[type="submit"]'),
            document.getElementById('recordButton')
        ];
        elements.forEach(el => { if (el) el.disabled = disabled; });
        if (!disabled) document.getElementById('messageText').focus();
    }

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
    connectWebSocket();
    </script>
</body>
</html>
